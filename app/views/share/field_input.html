{{- $labelWidth := (default .labelWidth "3" )}}
{{- $controlWidth := (default .controlWidth "9" )}}
{{- $fieldName := (default .fieldName .field.Name )}}
{{- $fieldLabel := (default .fieldLabel (default .field.Label .field.Name)) }}
{{- $inputTheme := (default .inputTheme "bootstrap3" ) }}
{{- $disabled := (default .disabled "" )}}

{{- if eq (print  (index .field.Annotations "input_type")) "text"}}
  {{text_field . $fieldName (concat $fieldLabel ":") | f_addTag $disabled | f_setValue .value | f_addData "labelWidth" $labelWidth | f_addData "controlWidth" $controlWidth | f_addClass ( .field.CSSClasses ) |f_setTheme $inputTheme | render}}
{{- else if  eq (print  (index .field.Annotations "input_type")) "area"}}
  {{textarea_field . $fieldName (concat $fieldLabel ":") 5 0 | f_addTag $disabled | f_setValue .value | f_addData "labelWidth" $labelWidth | f_addData "controlWidth" $controlWidth | f_addClass ( .field.CSSClasses ) |f_setTheme $inputTheme | render}}
{{- else if eq (print  (index .field.Annotations "input_type")) "select"}}
  {{- if .field.HasChoices}}
    {{- if .field.IsArray}}
      {{select_field . $fieldName (concat $fieldLabel ":") ( .field.ToChoices ) | f_addTag $disabled| f_addClass "chosen"| f_addParams "data-placeholder"  "请选择" |f_multiple | f_setValue ( default .value  `[]` )| f_addData "labelWidth" $labelWidth | f_addData "controlWidth" $controlWidth |f_setTheme $inputTheme | render}}
    {{- else}}
      {{select_field . $fieldName (concat $fieldLabel ":") ( .field.ToChoices ) | f_addTag $disabled| f_setValue .value| f_addData "labelWidth" $labelWidth | f_addData "controlWidth" $controlWidth |f_setTheme $inputTheme | render}}
    {{- end}}
  {{- else}}
    {{select_field . $fieldName (concat $fieldLabel ":") `[]` | f_addTag $disabled | f_setValue .value | f_addData "labelWidth" $labelWidth | f_addData "controlWidth" $controlWidth |f_setTheme $inputTheme | render}}
  {{- end}}
{{- else if eq (print  (index .field.Annotations "input_type")) "checkbox"}}
  {{- if eq (toString .value) "true"}}
    {{checkbox_field . $fieldName  $fieldLabel | f_addTag $disabled | f_addTag "checked" | f_addData "labelWidth" $labelWidth | f_addData "controlWidth" $controlWidth | f_addClass ( .field.CSSClasses ) |f_setTheme $inputTheme | render}}
  {{- else}}
    {{checkbox_field . $fieldName $fieldLabel | f_addTag $disabled | f_addData "labelWidth" $labelWidth | f_addData "controlWidth" $controlWidth | f_addClass ( .field.CSSClasses ) |f_setTheme $inputTheme | render}}
  {{- end}}
{{- else if eq (print  (index .field.Annotations "input_type")) "multiline"}}
  {{$dataFields := classFields (int64 (index .field.Annotations "metaClassId"))}}
  {{$dataArray := .value}}
  {{template "share/form/wrap_field_header.html" args | arg "label"  $fieldLabel }}
    <table class="table table-bordered" {{if $dataArray}}data-index="{{len $dataArray}}"{{else}}data-index="0"{{end}} id="custom-input-table-{{.field.ID}}" style="margin-top: 10px;">
      <thead>
        <tr>
          {{range $dataFields}}
            <th>{{.Label}}</th>
          {{end}}
          {{if ne $disabled "disabled"}}
            <th style="width:120px;">操作</th>
          {{end}}
        </tr>
      </thead>
      <tbody>
        {{if $dataArray}}
          {{range $dataArray}}
            {{$dataRow := .}}
              <tr>
                {{range $dataFields}}
                  <td>
                    <input type="hidden" disabled field-name="{{.Name}}" value="{{index $dataRow .Name}}" />
                    <span class="field-text">{{index $dataRow .Name}}</span>
                  </td>
                {{end}}
                {{if ne $disabled "disabled"}}
                  <td>
                    <i class="fa fa-edit btn-edit-row field-edit-trigger"></i>
                    <i class="fa fa-trash btn-remove-row field-edit-trigger"></i>
                  </td>
                {{end}}
              </tr>
          {{end}}
        {{end}}
      </tbody>
    </table>
    <input id="custom-input-field-{{.field.ID}}" class="value-field" type="hidden" field-name="{{.Name}}" name="{{$fieldName}}" value="{{if .value}}{{print .value}}{{end}}" />
    <table id="custom-input-table-tpl-{{.field.ID}}" style="display: none;">
      <tbody>
        <tr>
          {{range $dataFields}}
            <td>
              <input type="hidden" disabled field-name="{{.Name}}" />
              <span class="field-text"></span>
            </td>
          {{end}}
          {{if ne $disabled "disabled"}}
            <td>
              <i class="fa fa-edit btn-edit-row field-edit-trigger"></i>
              <i class="fa fa-trash btn-remove-row field-edit-trigger"></i>
            </td>
          {{end}}
        </tr>
      </tbody>
    </table>
    {{template "share/modal_header.html" args | arg "title" "添加记录" | arg "id" (printf "custom-input-modal-%v" .field.ID)}}
        {{range $dataFields}}
          {{template "share/field_input.html" args | arg "field" .}}
        {{end}}
    {{template "share/modal_footer_for_edit.html" .}}

    {{if not $disabled}}
      <a class="btn btn-default field-edit-trigger" id="btnAdd{{.field.ID}}"><i class="fa fa-plus"></i></a>
    {{end}}
    <script type="text/javascript">
      $(function(){
        $("#custom-input-table-{{.field.ID}}").delegate(".btn-remove-row", "click", function(){
          var $row = $(this).parents("tr:first");
          bootbox.confirm("确定删除该记录？", function (result) {
            if(result) {
              $row.remove();
            }
          });
        });

        $("#custom-input-table-{{.field.ID}}").delegate(".btn-edit-row", "click", function(){
          var $row = $(this).parents("tr:first");
          var nowData = {};
          $row.find("input").each(function(){
            nowData[$(this).attr("field-name")] = $(this).val();
          });

          Modal.show("#custom-input-modal-{{.field.ID}}", function(result){
            $row.find("input:hidden").each(function(){
              var fieldName = $(this).attr("field-name");
              var fieldValue = result.jsonObject[fieldName];
              var fieldLabel = result.valueLabels[fieldValue];

              $(this).val(fieldValue);
              $(this).parent().find(".field-text").text(fieldLabel ? fieldLabel : fieldValue);
            });

          }, {data:nowData});
        });

        $("#btnAdd{{.field.ID}}").click(function(){
          Modal.show("#custom-input-modal-{{.field.ID}}", function(result){
            var dataIndex = parseInt($("#custom-input-table-{{.field.ID}}").attr("data-index"));
            $("#custom-input-table-{{.field.ID}}").attr("data-index", dataIndex + 1);

            var $tr = $("#custom-input-table-tpl-{{.field.ID}} tbody tr").clone();

            $tr.find("input:hidden").each(function(){
              var fieldName = $(this).attr("field-name");
              var fieldValue = result.jsonObject[fieldName];
              var fieldLabel = result.valueLabels[fieldValue];

              $(this).val(fieldValue);
              $(this).parent().find(".field-text").text(fieldLabel ? fieldLabel : fieldValue);
            });

            $("#custom-input-table-{{.field.ID}} tbody").append($tr);
          });
        });

        $("#custom-input-field-{{.field.ID}}").parents("form:first").submit(function(){
          var dataArray = [];
          $("#custom-input-table-{{.field.ID}} tbody tr").each(function(){
            var dataObj = {};
            dataArray.push(dataObj);
            $(this).find("input:hidden").each(function(){
              var fieldName = $(this).attr("field-name");
              var fieldValue = $(this).val();
              dataObj[fieldName] = fieldValue;
            });
          });

          $("#custom-input-field-{{.field.ID}}").val(JSON.stringify(dataArray));
        });
      })
    </script>
  {{template "share/form/wrap_field_footer.html" args}}
{{- end}}
